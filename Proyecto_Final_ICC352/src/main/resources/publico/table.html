<!DOCTYPE html>
<html data-bs-theme="light" lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Table - RedtechSurvey</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/Nunito.css">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <script src="../jquery/jquery-3.2.1.min.js"></script>
</head>

<body id="page-top">

    <div id="wrapper">
        <nav class="navbar align-items-start sidebar sidebar-dark accordion bg-gradient-primary p-0 navbar-dark" style="background: var(--bs-info-text-emphasis);">
            <div class="container-fluid d-flex flex-column p-0"><a class="navbar-brand d-flex justify-content-center align-items-center sidebar-brand m-0" href="#">
                    <div class="sidebar-brand-icon rotate-n-15"><i class="fas fa-laugh-wink"></i></div>
                    <div class="sidebar-brand-text mx-3"><span>RedtechSurvey</span></div>
                </a>
                <hr class="sidebar-divider my-0">
                <ul class="navbar-nav text-light" id="accordionSidebar">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="sinoDesconexion()"><i class="far fa-list-alt" style="font-size: 14px;"></i><span>Survey</span></a></li>
                    <li class="nav-item"><a class="nav-link active" href="list.html"><i class="fas fa-table" style="font-size: 14px;"></i><span>Table</span></a><a class="nav-link" href="list.html"><i class="far fa-edit" style="font-size: 14px;"></i><span>List</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="login.html"><i class="far fa-user-circle"></i><span>Login</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="register.html"><i class="fas fa-user-circle"></i><span>Register</span></a></li>
                </ul>
                <div class="text-center d-none d-md-inline"><button class="btn rounded-circle border-0" id="sidebarToggle" type="button"></button></div>
            </div>
        </nav>
        <div class="d-flex flex-column" id="content-wrapper">
            <div id="content">
                <nav class="navbar navbar-expand bg-white shadow mb-4 topbar static-top navbar-light">
                    <div class="container-fluid"><button class="btn btn-link d-md-none rounded-circle me-3" id="sidebarToggleTop" type="button"><i class="fas fa-bars"></i></button>
                        <ul class="navbar-nav flex-nowrap ms-auto">
                            <li class="nav-item dropdown d-sm-none no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"><i class="fas fa-search"></i></a>
                                <div class="dropdown-menu dropdown-menu-end p-3 animated--grow-in" aria-labelledby="searchDropdown">
                                    <form class="me-auto navbar-search w-100">
                                        <div class="input-group"><input class="bg-light form-control border-0 small" type="text" placeholder="Search for ...">
                                            <div class="input-group-append"><button class="btn btn-primary py-0" type="button"><i class="fas fa-search"></i></button></div>
                                        </div>
                                    </form>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"></a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header">alerts center</h6><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="me-3">
                                                <div class="bg-primary icon-circle"><i class="fas fa-file-alt text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 12, 2019</span>
                                                <p>A new monthly report is ready to download!</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="me-3">
                                                <div class="bg-success icon-circle"><i class="fas fa-donate text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 7, 2019</span>
                                                <p>$290.29 has been deposited into your account!</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="me-3">
                                                <div class="bg-warning icon-circle"><i class="fas fa-exclamation-triangle text-white"></i></div>
                                            </div>
                                            <div><span class="small text-gray-500">December 2, 2019</span>
                                                <p>Spending Alert: We've noticed unusually high spending for your account.</p>
                                            </div>
                                        </a><a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item dropdown no-arrow mx-1">
                                <div class="nav-item dropdown no-arrow"><a class="dropdown-toggle nav-link" aria-expanded="false" data-bs-toggle="dropdown" href="#"></a>
                                    <div class="dropdown-menu dropdown-menu-end dropdown-list animated--grow-in">
                                        <h6 class="dropdown-header">alerts center</h6><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar4.jpeg">
                                                <div class="bg-success status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>Hi there! I am wondering if you can help me with a problem I've been having.</span></div>
                                                <p class="small text-gray-500 mb-0">Emily Fowler - 58m</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar2.jpeg">
                                                <div class="status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>I have the photos that you ordered last month!</span></div>
                                                <p class="small text-gray-500 mb-0">Jae Chun - 1d</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar3.jpeg">
                                                <div class="bg-warning status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>Last month's report looks great, I am very happy with the progress so far, keep up the good work!</span></div>
                                                <p class="small text-gray-500 mb-0">Morgan Alvarez - 2d</p>
                                            </div>
                                        </a><a class="dropdown-item d-flex align-items-center" href="#">
                                            <div class="dropdown-list-image me-3"><img class="rounded-circle" src="assets/img/avatars/avatar5.jpeg">
                                                <div class="bg-success status-indicator"></div>
                                            </div>
                                            <div class="fw-bold">
                                                <div class="text-truncate"><span>Am I a good boy? The reason I ask is because someone told me that people say this to all dogs, even if they aren't good...</span></div>
                                                <p class="small text-gray-500 mb-0">Chicken the Dog · 2w</p>
                                            </div>
                                        </a><a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                                    </div>
                                </div>
                                <div class="shadow dropdown-list dropdown-menu dropdown-menu-end" aria-labelledby="alertsDropdown"></div>
                            </li>

                        </ul>
                    </div>
                </nav>

                <div class="container-fluid">
                    <h3 class="text-dark mb-4">Survey</h3>
                    <button id="botonSubir" style=" padding: 8px 12px; background-color: mediumspringgreen;color: black; border: 2px solid #164A52;cursor: pointer; border-radius: 20px;">Subir Datos</button>
                    <button id="Reload" onclick="show()" style=" padding: 8px 12px; background-color: dodgerblue;color: white; border: 2px solid #164A52;cursor: pointer; border-radius: 20px;">Reload</button>

                    <div class="card shadow">
                        <div class="card-header py-3">
                            <p class="text-primary m-0 fw-bold">Info</p>
                        </div>
                        <div class="card-body">

                            <div class="table-responsive table mt-2" id="dataTable" role="grid" aria-describedby="dataTable_info">
                                <table class="table my-0" id="dataTable1">
                                    <thead>
                                        <tr>
                                            <td><strong>Formulario</strong></td>
                                            <td><strong>Encuesta</strong></td>
                                            <td><strong>Datos</strong></td>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaCuerpo">

                                        <!--<tr>
                                            <td>Senior JavaScript Developer</td>
                                            <td>Edinburgh</td>
                                            <td>22</td>
                                        </tr>-->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td><strong>Formulario</strong></td>
                                            <td><strong>Encuesta</strong></td>
                                            <td><strong>Datos</strong></td>
                                            <td><strong>Action</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="row">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="bg-white sticky-footer">
                <div class="container my-auto">
                    <div class="text-center my-auto copyright"><span>Copyright © RedtechSurvey 2023</span></div>
                </div>
            </footer>
        </div><a class="border rounded d-inline scroll-to-top" href="#page-top"><i class="fas fa-angle-up"></i></a>
    </div>
   <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/theme.js"></script>
    <script>
        var request = window.indexedDB.open("miBaseDeDatos", 1);
        var db;
        request.onsuccess = function(event) {
            db = event.target.result;
            show();
        };

        function show() {
            var transaction = db.transaction(["formularios"], "readwrite");
            var objectStore = transaction.objectStore("formularios");

            var tablaCuerpo = document.getElementById("tablaCuerpo");
            tablaCuerpo.innerHTML = '';

            objectStore.openCursor().onsuccess = function(event) {
                var cursor = event.target.result;
                if (cursor) {
                    var fila = tablaCuerpo.insertRow();

                    var celdaId = fila.insertCell();
                    var celdaNombre = fila.insertCell();
                    var celdaDatos = fila.insertCell();
                    var celdaEliminar = fila.insertCell();

                    celdaId.textContent = cursor.value.formulario;
                    celdaNombre.textContent = cursor.key;
                    celdaDatos.textContent = JSON.stringify(cursor.value.data);

                    var botonEliminar = document.createElement("button");
                    botonEliminar.textContent = "Eliminar";
                    celdaEliminar.appendChild(botonEliminar);

                    botonEliminar.addEventListener("click", function() {
                        var deleteTransaction = db.transaction(["formularios"], "readwrite");
                        var deleteObjectStore = deleteTransaction.objectStore("formularios");

                        deleteObjectStore.delete(cursor.key);
                        fila.remove();
                    });

                    cursor.continue();
                }
            };
        }

        var botonSubir = document.getElementById("botonSubir");
        botonSubir.addEventListener("click", function() {
            if(verificarConexion()==false){
                subirFormularios();
                show();
            }else{
                console.log("No hay conexion para subir datos")
            }
            verificarConexion().then(function (conexionExitosa) {
                if (conexionExitosa) {
                    subirFormularios();
                    show();
                } else {
                    obtenerContenidoOffline();
                }
            });

        });

        function subirFormularios() {
            var transaction = db.transaction(["formularios"], "readwrite");
            var objectStore = transaction.objectStore("formularios");
            var request = objectStore.openCursor();

            request.onsuccess = function(event) {
                var cursor = event.target.result;
                if (cursor) {
                    var formData = {
                        formulario: cursor.value.formulario,
                        data: cursor.value.data
                    };
                    const queryString = window.location.search;

                    const params = new URLSearchParams(queryString);

                    fetch("/subir-formulario", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "data" : params.get("data")

                        },
                        body: JSON.stringify(formData)
                    }).then(response => {


                    }).catch(error => {
                        console.error("Error al subir el formulario:", error);
                    });
                        cursor.delete();
                        cursor.continue();


                } else {
                    console.log("Se completó el recorrido de formularios.");
                }
            };

            request.onerror = function(event) {
                console.error("Error al abrir el cursor:", request.error);
            };

            transaction.oncomplete = function(event) {
                console.log("Transacción completada, registros eliminados.");
            };

            transaction.onerror = function(event) {
                console.error("Error en la transacción:", transaction.error);
            };
        }



        ////////////////////////////////////////////////

        function sinoDesconexion() {
            verificarConexion().then(function (conexionExitosa) {
                if (conexionExitosa) {
                    window.location.href = "/survey";
                    //obtenerContenidoOffline();
                } else {
                    obtenerContenidoOffline();
                }
            });
        }

        function abrirNuevaVentana(contenido) {
            var nuevaVentana = window.open("", "_blank");
            //cargarContenidoYScripts(contenido);
            nuevaVentana.document.write(contenido);
            nuevaVentana.document.close();
        }
        function obtenerContenidoOffline() {
            var request = indexedDB.open("desconexion", 1);

            request.onsuccess = function (event) {
                var db = event.target.result;

                var transaction = db.transaction("archivo", "readonly");
                var fileStore = transaction.objectStore("archivo");

                var getRequest = fileStore.get("survey.html");

                getRequest.onsuccess = function (event) {
                    var fileData = event.target.result;

                    var htmlContent = fileData.content;
                    abrirNuevaVentana(htmlContent);
                };
            };
        }

        function mostrarContenido(contenido) {
            //console.log(contenido);
            document.documentElement.innerHTML = contenido;
            cargarContenidoYScripts(contenido);
        }
        function cargarContenidoYScripts(contenido) {
            var tempDiv = document.createElement("div");
            tempDiv.innerHTML = contenido;

            // Extraer scripts del contenido y ejecutarlos uno por uno
            var scripts = tempDiv.getElementsByTagName("script");
            for (var i = 0; i < scripts.length; i++) {
                var script = document.createElement("script");
                if (scripts[i].src) {
                    script.src = scripts[i].src;
                } else {
                    script.textContent = scripts[i].textContent;
                }
                document.head.appendChild(script);
            }

            // Agregar el contenido al documento
            document.body.innerHTML = tempDiv.innerHTML;
            reasignarListener();

        }
        function reasignarListener() {
            var coll = document.getElementsByClassName("collapsible");
            var i;

            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    console.log("Click")
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.maxHeight){
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            }// Aquí puedes reasignar el listener o recrear cualquier interacción necesaria
        }





        function verificarConexion() {
            return new Promise(function (resolve, reject) {
                $.ajax({
                    url: "/",
                    method: "HEAD",
                    timeout: 5000,
                    success: function () {
                        console.log("Conexión exitosa");
                        resolve(true);
                    },
                    error: function () {
                        console.log("No se pudo conectar al servidor");
                        resolve(false);
                    }
                });
            });
        }

        // En algún lugar donde desees utilizar la función de verificación
        verificarConexion().then(function (conexionExitosa) {
            if (conexionExitosa) {
                // Aquí puedes realizar acciones en caso de conexión exitosa
                // No es necesario hacer nada si no hay conexión, ya que no se redirecciona automáticamente
            } else {
                // Aquí puedes mostrar un mensaje o tomar alguna acción en caso de falta de conexión
                console.log("No hay conexión. No se realizó ningún cambio en la vista.");
            }
        }).catch(function (error) {
            console.error("Error al verificar conexión:", error);
        });

    </script>


</body>

</html>